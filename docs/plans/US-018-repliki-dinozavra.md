# US-018: Короткие реплики динозавра на события ритма

## Цель
Добавить короткие реплики динозавра во время сессии как эмоциональный фидбек на `perfect/good/miss`, не ломая текущие метрики, streak и читаемость Session UI.

## Acceptance Criteria (из стори)
1. При successful hit (`perfect/good`) показывается позитивная реплика.
2. При `miss` показывается отдельная реплика поддержки/реакции.
3. Реплики выбираются случайно из набора, без повторов подряд.
4. Реплика читаема и не перекрывает критичный UI.
5. Показ реплики имеет короткий TTL и плавное исчезновение.
6. Реплики можно отключить флагом/конфигом для быстрых A/B тестов.

## Затрагиваемые файлы
- `src/web/index.html` (контейнер реплики на Session Screen)
- `src/web/styles/main.css` (позиционирование, стили bubble, fade-анимация, reduced-motion)
- `src/web/js/app.js` (логика выбора/показа/скрытия реплик, cooldown, config flag)
- `src/web/js/locations/RunnerLocation.js` (ожидается без изменений; валидация интеграции через `Animator.onHit`)

## Vertical Slices

### Slice 1: UI-контейнер и визуал реплики
Изменения:
1. Добавить в `Session Screen` отдельный overlay-контейнер для реплики (поверх canvas, но не на таймере/streak).
2. Оформить bubble в стиле текущего UI: высокий контраст, крупный шрифт, ограничение ширины, мягкая тень.
3. Добавить анимацию появления/исчезновения и fallback для `prefers-reduced-motion`.

Проверка slice:
1. Bubble читаем на экране и не мешает таймеру/кнопке `Стоп`/streak.
2. При скрытом состоянии overlay не перехватывает клики.

### Slice 2: Логика реплик и анти-спам
Изменения:
1. В `app.js` добавить словари реплик:
   - `positive` для `perfect/good`
   - `miss` для `miss`
2. Реализовать случайный выбор без повтора подряд внутри каждого словаря.
3. Реализовать показ с TTL (например 900-1200ms) и controlled fade-out.
4. Добавить cooldown (например 350-500ms), чтобы не спамить overlay на очень частых ударах.
5. Триггерить показ в текущем `sensor.onHit` после получения `result.zone`.

Проверка slice:
1. На серии `perfect/good` идут позитивные фразы.
2. На `miss` идут отдельные поддерживающие/реактивные фразы.
3. Повтор одной и той же фразы подряд не происходит.
4. При частых ударах UI остаётся стабильным, без «дребезга» текста.

### Slice 3: Конфиг для A/B и регрессии
Изменения:
1. Добавить конфиг-флаг `dinoSpeechEnabled` в настройки (через `localStorage`, без изменения текущего UX формы).
2. Значение по умолчанию: `true`, с безопасным fallback при старых сохранённых настройках.
3. Если флаг выключен, логика показа реплик полностью не активируется.
4. Проверить, что существующие потоки (`Animator.onHit`, streak, stats, start/stop) не меняют поведение.

Проверка slice:
1. При `dinoSpeechEnabled=false` реплики не показываются.
2. При `dinoSpeechEnabled=true` реплики работают стабильно.
3. Статистика и streak совпадают с ожидаемыми значениями как до изменений.

## Технические детали реализации
1. Держать состояние реплик локально в `app.js`:
   - ссылки на DOM-элементы,
   - `lastMessageByGroup`,
   - `lastShownAt`,
   - `hideTimeoutId`.
2. Не менять контракт `Animator`/`RunnerLocation`; реплики работают на уровне Session UI.
3. Для выбора фразы использовать guard: если в словаре 1 элемент, вернуть его без рандома.
4. При `onStopClick` сбрасывать/очищать активный timeout, чтобы избежать «долетевшего» показа после остановки.

## Риски и контроль
1. Риск: bubble перекроет важные элементы Session Screen.
   - Контроль: фиксированная безопасная зона размещения, `pointer-events: none`, проверка на разных ширинах.
2. Риск: визуальный шум при частых хитах.
   - Контроль: cooldown + ограниченный TTL + короткие тексты.
3. Риск: регрессия сохранения настроек.
   - Контроль: добавить флаг в общий объект настроек с backward-compatible fallback.

## Чек-лист тестирования
1. Session (`runner`): `perfect/good` показывают позитивные реплики.
2. Session (`runner`): `miss` показывает отдельные реплики поддержки/реакции.
3. Нет повторов одной и той же фразы подряд в одной группе.
4. Реплика исчезает автоматически с плавным fade-out.
5. Таймер, streak и кнопка `Стоп` остаются читаемыми и кликабельными.
6. Start/Stop x5: нет ошибок в консоли, нет зависших timeout.
7. `localStorage` флаг `dinoSpeechEnabled=false`: реплики отключены.
8. Stats и streak соответствуют фактическим попаданиям (без изменений логики подсчёта).

## Что не меняем в этой стори
1. Алгоритм оценки зон (`RhythmAnalyzer`) и пороги.
2. Внутреннюю графику/эффекты `RunnerLocation`.
3. Edge-вспышки по периметру экрана (`US-019`).
