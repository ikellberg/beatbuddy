# План US-005: Анализ точности попадания в ритм

## Цель
Создать модуль `RhythmAnalyzer` который определяет, попал ли удар в такт метронома, и вычисляет статистику точности.

## Ключевое упрощение
**НЕ трогаем MetronomeEngine.** Анализатор сам вычисляет время битов по формуле:
```
beatTime = startTime + (beatNumber * 60 / bpm)
```

Это работает, потому что темп постоянный, а `startTime` известен.

## Изменения в существующих файлах

### `src/web/js/app.js` — создать анализатор и передавать данные

**В функции `startSession()`:**
- Создать `rhythmAnalyzer = new RhythmAnalyzer(startTime, bpm, thresholdMs)`
- В обработчике `sensor.onHit()` вызывать `rhythmAnalyzer.recordHit(event.timestamp / 1000)`
- Логировать результаты

## Новый файл

### `src/web/js/RhythmAnalyzer.js`

```javascript
export class RhythmAnalyzer {
  constructor(startTime, bpm, thresholdMs = 100) {
    this.startTime = startTime      // AudioContext время первого клика
    this.bpm = bpm
    this.thresholdMs = thresholdMs
    this.totalHits = 0
    this.hits = 0
    this.misses = 0
  }

  // Обработка удара. hitTime — в секундах (performance.now() / 1000)
  recordHit(hitTime) {
    const beatNumber = Math.round((hitTime - this.startTime) * this.bpm / 60)
    const expectedBeatTime = this.startTime + (beatNumber * 60 / this.bpm)
    const deviation = (hitTime - expectedBeatTime) * 1000  // в мс
    const isHit = Math.abs(deviation) <= this.thresholdMs

    this.totalHits++
    if (isHit) this.hits++
    else this.misses++

    return { isHit, deviation, beatNumber }
  }

  getAccuracy() {
    return {
      totalHits: this.totalHits,
      hits: this.hits,
      misses: this.misses,
      accuracyPercent: this.totalHits > 0
        ? (this.hits / this.totalHits * 100).toFixed(1)
        : 0
    }
  }

  reset() {
    this.totalHits = 0
    this.hits = 0
    this.misses = 0
  }
}
```

## Проблема времени (важно!)

**Критично:** первый клик метронома — НЕ сразу, а через `60/bpm` секунд.

```javascript
// В startSession():
const sessionStartTime = performance.now() / 1000
const firstBeatDelay = 60 / settings.bpm  // учесть задержку первого клика
rhythmAnalyzer = new RhythmAnalyzer(sessionStartTime + firstBeatDelay, settings.bpm, 100)
```

**Сброс при остановке:**
```javascript
// В onStopClick():
if (rhythmAnalyzer) {
  console.log('[App] Final accuracy:', rhythmAnalyzer.getAccuracy())
  rhythmAnalyzer = null
}
```

## Vertical Slices

### Slice 1: Создать RhythmAnalyzer
- Создать `src/web/js/RhythmAnalyzer.js`
- Реализовать весь класс
- Проверить синтаксис

### Slice 2: Интеграция в app.js
- Создать анализатор при старте сессии
- Передавать удары из сенсора
- Логировать результаты
- Сбрасывать при остановке

## Приёмка

- [ ] `recordHit()` возвращает `{ isHit, deviation, beatNumber }`
- [ ] Попадание определяется как `|deviation| <= 100ms`
- [ ] `getAccuracy()` возвращает корректную статистику
- [ ] В консоли видны результаты каждого удара
- [ ] Процент точности считается правильно
- [ ] **Ручной тест:** 60 BPM, бить ровно в такт → deviation ≈0 (±30ms)
- [ ] **Ручной тест:** удар раньше/позже на 150ms → промах
- [ ] **Ручной тест:** удар точно в бит → попадание с deviation ≈0

## Файлы

| Файл | Действие |
|------|----------|
| `src/web/js/RhythmAnalyzer.js` | Создать |
| `src/web/js/app.js` | Изменить |
