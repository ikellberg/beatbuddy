# US-019: Полноэкранные edge-вспышки по зонам точности

## Цель
Заменить/усилить текущий hit-фидбек в Session на заметные edge-вспышки по периметру экрана с разной интенсивностью и длительностью для `perfect/good/miss`, не ухудшая читаемость таймера и streak, и добавить безопасный fallback для слабого FPS.

## Acceptance Criteria (из стори)
1. Вместо слабых локальных волн используется edge-вспышка по периметру экрана.
2. `perfect` = зелёная вспышка, `good` = жёлтая, `miss` = красная.
3. Интенсивность и длительность эффекта различаются по зонам.
4. Эффект не ухудшает читаемость таймера и streak-индикатора.
5. Эффект отрабатывает каждый hit без заметного лага.
6. Есть fallback на менее тяжёлый вариант эффекта при низком FPS.

## Затрагиваемые файлы
- `src/web/js/locations/RunnerLocation.js` (основная реализация edge-вспышек в Pixi, FPS degrade и cleanup)

## Vertical Slices

### Slice 1: Базовый edge-overlay в Pixi и маппинг по зонам
Изменения:
1. В `RunnerLocation` добавить отдельный слой `edgeFlashGraphics`, который рисует edge-рамку по краям экрана (центр остаётся чистым), и разместить его в z-order после `effectsGraphics`, но до `speechGraphics`/`speechText`.
2. На `onHit(zone)` запускать edge-анимацию с цветом по зоне:
   - `perfect` → `PALETTE.perfect`
   - `good` → `PALETTE.good`
   - `miss` → `PALETTE.miss`
3. Для `miss` заменить текущий fullscreen `shake`-overlay на edge-вспышку (прыжок/спотыкание/частицы сохраняются), чтобы избежать двойного красного эффекта.
4. Обновить `destroy()`: уничтожать `edgeFlashGraphics` и сбрасывать состояние `activeEdgeFlash`.

Проверка slice:
1. На каждый hit видна вспышка именно по краям экрана.
2. Цвет соответствует зоне.
3. Таймер и streak визуально читаемы в момент вспышки.

### Slice 2: Разная интенсивность/длительность и контроль наложений
Изменения:
1. Добавить параметры пресетов по зонам (`alphaPeak`, `durationMs`, `thickness`, `easing`).
2. Зафиксировать стратегию наложения: перезапуск с `max-alpha` (новая вспышка стартует с `max(currentAlpha, peakAlpha)`), без очереди.
3. Подкрутить значения так, чтобы `perfect` ощущался самым «праздничным», `good` умеренным, `miss` резким и короче/жёстче.

Проверка slice:
1. Отличия между зонами заметны без чтения текста.
2. На серии частых ударов нет визуального дребезга и пропусков эффекта.
3. В `runner` не появляется заметная просадка плавности.

### Slice 3: FPS fallback (degrade) и защита производительности
Изменения:
1. Добавить лёгкий runtime-монитор FPS в `RunnerLocation` (скользящее среднее за окно кадров), где frame time считается как `performance.now()` delta между вызовами `onBeat`.
2. При падении ниже порога (например, <45 FPS стабильно N кадров) включать degrade-режим edge-вспышки:
   - меньше сегментов/примитивов,
   - ниже альфа/толщина,
   - упрощённый рендер без «тяжёлых» операций.
3. При восстановлении FPS выше верхнего порога (hysteresis) возвращать normal-режим.
4. Логировать переключение режима (`normal -> degrade -> normal`) для диагностики.

Проверка slice:
1. При искусственной нагрузке эффект становится легче, но остаётся заметным.
2. После снятия нагрузки режим возвращается в normal.
3. Нет утечек/зависших объектов после `Start/Stop` x5.

## Технические детали реализации
1. Держать состояние edge-вспышки в отдельной структуре (`activeEdgeFlash`) c `zone`, `startedAt`, `durationMs`, `peakAlpha`, `mode`.
2. Градиент edge реализовать через 3-4 вложенные рамки (`drawRect`) с убывающей alpha к центру (без shader/filter), чтобы решение было лёгким и предсказуемым на слабом GPU.
3. Для читаемости UI ограничить внутреннюю глубину вспышки (примерно 8-14% minSide).
4. Все новые Pixi-объекты уничтожать в `destroy()` вместе с остальными слоями.
5. Не менять контракт `Animator.onHit(result)` и внешние API приложения.

## Риски и контроль
1. Риск: edge-вспышка перекрывает таймер/streak.
   Контроль: ограничение альфы + глубины эффекта + тест на разных разрешениях.
2. Риск: деградация FPS на слабом GPU.
   Контроль: adaptive degrade + минимизация per-frame аллокаций.
3. Риск: регресс поведения раннера при частых hit.
   Контроль: ручной прогон серий `perfect/good/miss`, Start/Stop циклы, проверка логов.

## Чек-лист тестирования
1. `perfect` всегда даёт зелёную edge-вспышку.
2. `good` всегда даёт жёлтую edge-вспышку.
3. `miss` всегда даёт красную edge-вспышку.
4. Интенсивность/длительность визуально различимы между зонами.
5. Таймер и streak остаются читаемыми во время вспышек.
6. На частых hit нет пропадания/залипания эффекта.
7. При низком FPS включается degrade-режим, при нормализации — отключается.
8. `Start/Stop` x5: без ошибок в консоли и без «висячих» слоёв.

## Что не меняем в этой стори
1. Алгоритм зон и порогов в `RhythmAnalyzer`.
2. Бизнес-логику streak и статистики.
3. Контент реплик динозавра (`US-018`).
