# US-011: Интеграция PixiJS для анимаций

## Контекст

Сейчас `Animator` рисует на Canvas 2D, а `app.js` использует API `start() / stop() / onHit(result)`. По требованиям стори нужно заменить рендер на PixiJS (WebGL), сохранить API для `app.js` и добавить явный fallback при недоступном WebGL.

## Ограничения

- Не ломаем текущий lifecycle экрана Session (`onStartClick`/`onStopClick`).
- Публичный API `Animator` для `app.js` остаётся прежним.
- CDN-подключение PixiJS через `index.html`.
- При отсутствии WebGL не молчим: показываем сообщение пользователю и продолжаем работу приложения без падения.
- Целевая среда: Windows 7 + Chrome, поэтому важны cleanup и контроль нагрузки.
- Синхронизация фоновой анимации с BPM должна сохраниться (фаза волны считается по elapsed time и BPM, как в текущей реализации).

## Файлы

- `src/web/index.html` — подключение PixiJS CDN
- `src/web/js/Animator.js` — новая PixiJS-реализация с fallback-поведением
- `src/web/js/app.js` — минимальная адаптация обработки fallback-сообщений от аниматора

## План по vertical slices

### Слайс 1: Базовое подключение PixiJS и инициализация сцены

- Подключить PixiJS через CDN до `app.js`.
- Переписать `Animator` на PixiJS:
- создать `PIXI.Application` внутри переданного `canvas`-контейнера;
- перенести базовую фоновую пульсацию в такт BPM (ticker/update loop + расчет фазы от elapsed time/BPM);
- реализовать `start()`/`stop()` с корректным destroy и очисткой ресурсов.
- Добавить обработку ошибок инициализации (`canvas` отсутствует, невалидные размеры, исключение при создании Pixi app) с безопасным завершением без падения страницы.

**Тест:** старт/стоп сессии проходит без ошибок в консоли, в Session видна пульсация в такт.

### Слайс 2: Реакция на удары по зонам

- Реализовать `onHit(result)` в PixiJS:
- разные цвета для `perfect/good/miss`;
- разные параметры эффекта (скорость/толщина/затухание).
- Ограничить количество активных эффектов для стабильной производительности.

**Тест:** в dev mode при ударах видно отличимые эффекты для всех зон, приложение остаётся отзывчивым.

### Слайс 3: Fallback при недоступном WebGL

- Добавить детекцию доступности WebGL перед запуском Pixi.
- Если WebGL недоступен:
- не падать исключением;
- вернуть диагностический статус/сообщение из `Animator` (`getStatus()` или эквивалент);
- отобразить пользователю сообщение в `#metronome-status` через `app.js`;
- использовать явный текст: `Анимация недоступна: WebGL не поддерживается в этом браузере`.
- Аниматор в fallback-режиме не рендерит эффекты, но сессия, метроном, сенсор и статистика работают штатно.

**Тест:** принудительный сценарий “WebGL unavailable” показывает понятное сообщение, session не ломается.

### Слайс 4: Стабилизация и очистка памяти

- Проверить, что `stop()` освобождает ticker, stage-объекты и destroy Pixi app.
- Добавить защиту от повторных `start()`/`stop()`.
- Проверить стабильность 60fps во время сессии (через `app.ticker.FPS` и/или DevTools Performance).
- Провести 10+ минутный прогон и проверить отсутствие нарастающих утечек памяти в DevTools (heap/timeline без устойчивого роста).
- Прогнать ручной smoke-тест нескольких циклов Setup → Session → Stats.

**Тест:** после нескольких запусков подряд нет накопления артефактов/ошибок, консоль чистая.

## Верификация

- Ручной проход: Setup → Start → Session → Stop → Stats → Новое занятие (несколько раз).
- Проверка dev mode (клавиатура) на реакцию зон.
- Проверка fallback-сценария (имитация отсутствия WebGL).
- Проверка в целевой среде Windows 7 + Chrome (или максимально близкая эмуляция): запуск сессии, визуальные эффекты, fallback-поведение, отсутствие деградации FPS.
