# US-013: Локация «Лес/Природа»

## Context

Beat Buddy имеет систему локаций (US-012): LocationRegistry + DefaultLocation (пульсирующие круги). Нужна вторая локация — лесная сцена, где деревья, цветы и бабочки реагируют на удары ребёнка в такт метроному.

## Файлы

- **Создать:** `src/web/js/locations/ForestLocation.js`
- **Изменить:** `src/web/js/Animator.js` (добавить side-effect import)

## Подход

Процедурная графика через `PIXI.Graphics` (как DefaultLocation) — без внешних ассетов/текстур. Это проще, надёжнее на Windows 7, и не требует загрузки файлов.

## Архитектура ForestLocation

Фабрика `createForestLocation()` возвращает объект с `{init, onBeat, onHit, destroy}`.
Регистрация: `register('forest', 'Лес', createForestLocation)` — вызывается при импорте модуля.

### Производительность

- **Один объект `PIXI.Graphics`** на всю сцену (как в DefaultLocation) — `clear()` + перерисовка каждый кадр
- **Никаких аллокаций в `onBeat()`** — все массивы (деревья, цветы, бабочки, эффекты) создаются в `init()`
- **Лимит частиц/эффектов:** максимум 8 одновременных частиц, максимум 3 активных эффекта; новые вытесняют старые
- **Переиспользование данных:** эффекты — plain objects в pre-allocated массиве, не new на каждый удар

### Сцена (init)

Элементы описываются как данные в `init()`, рисуются в `onBeat()`:

1. **Фон** — 4-5 горизонтальных прямоугольников с градацией цвета от голубого (верх) к зелёному (низ), каждый с фиксированной заливкой
2. **Земля** — зелёная полоса внизу (~20% высоты) + холмистая линия через `bezierCurveTo`
3. **Деревья (3-5 шт)** — массив `{x, y, trunkH, crownR}`, стволы (прямоугольники) + кроны (круги), расставлены по сцене
4. **Цветы (5-8 шт)** — массив `{x, y, petalR, color}`, стебель (линия) + лепестки (круги)
5. **Бабочки (2-3 шт)** — массив `{baseX, baseY, size, speed, offset}`, крылья (треугольники/эллипсы)

Все размеры относительные (через `minSide = Math.min(w, h)`).

### Анимации

**onBeat(phase):**
- Деревья: кроны смещаются по X на `sin(phase * 2π) * amplitude` (малая амплитуда ~2-3% minSide)
- Цветы: стебли наклоняются (смещение верхней точки по X)
- Бабочки: движение по синусоидной траектории (X = baseX + sin(t), Y = baseY + cos(t * 0.7)), крылья «хлопают» (масштаб по X от phase)
- Активные эффекты: обновить progress, нарисовать, удалить истёкшие

**onHit('perfect'):**
- Цветы увеличиваются (множитель petalR) на 300ms
- Зелёный ореол вокруг центра сцены (большой круг, fade out)
- 5-8 частиц-блёсток: маленькие круги, разлетаются от центра радиально, затухают за 400ms

**onHit('good'):**
- Цветы слегка увеличиваются на 200ms
- Жёлтый ореол, менее интенсивный

**onHit('miss'):**
- 3-4 «листа» (маленькие эллипсы) падают сверху вниз за 500ms
- Тёмный overlay на 200ms (прямоугольник с alpha)

### destroy() — чек-лист очистки

1. Удалить `graphics` из `container`, вызвать `graphics.destroy()`
2. Обнулить: `graphics`, `container`, `trees`, `flowers`, `butterflies`, `effects`
3. Обнулить: `width`, `height`, `hitState`

## Слайс 1: Сцена + покачивание в такт

- Создать `ForestLocation.js`: фабрика, register, init, onBeat, destroy
- Фон, земля, деревья, цветы, бабочки — рисуются процедурно
- onBeat: покачивание + движение бабочек
- Side-effect import в `Animator.js`
- Пустой onHit (заглушка)

**AC:**
- При выборе «Лес» на Setup Screen и старте сессии видна лесная сцена
- Деревья покачиваются, бабочки двигаются синхронно с метрономом
- DefaultLocation по-прежнему работает при выборе «По умолчанию»
- После stop() + повторного start() сцена отрисовывается корректно (нет накопления объектов)

## Слайс 2: Реакции на удары

- onHit('perfect'/'good'/'miss') с эффектами
- Система эффектов с массивом и временем жизни

**AC:**
- `onHit('perfect')`: цветы увеличиваются, зелёный ореол, частицы-блёстки
- `onHit('good')`: умеренный эффект (жёлтый ореол, лёгкое увеличение цветов)
- `onHit('miss')`: падающие листья, потемнение
- Эффекты не накапливаются (лимит: 8 частиц, 3 эффекта)
- После 5-10 циклов start/stop визуальные объекты не накапливаются

## Проверка

1. Запустить приложение, выбрать «Лес», начать сессию — сцена живая
2. Детерминированная проверка зон через консоль браузера:
   ```js
   // Получить animator из app.js (экспортировать или через window)
   animator.onHit({zone: 'perfect'})
   animator.onHit({zone: 'good'})
   animator.onHit({zone: 'miss'})
   ```
3. Start/stop 5 раз подряд — нет визуальных артефактов
4. DefaultLocation работает без регрессий
