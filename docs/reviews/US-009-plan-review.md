# Ревью плана: US-009 - Зоны точности попадания

## Вердикт: Требует доработки

План описывает правильное направление изменений и использует существующие модули, но содержит пробелы в деталях реализации, которые могут привести к неоднозначности при выполнении.

---

## Соответствие архитектуре (project_state.md)

✅ **Правильно:**
- План использует существующие модули: `RhythmAnalyzer.js`, `Animator.js`, `app.js` — соответствует структуре проекта из `project_state.md`
- Пороги выбраны конкретно (±75ms, ±150ms) — расширяют текущий порог ±100ms из `project_state.md`
- Цвета соответствуют стандартным (зелёный, жёлтый, красный) — логично для детского интерфейса

⚠️ **Требует уточнения:**
- В `project_state.md` указано, что порог ±100ms подтверждён. План не объясняет, почему выбраны новые пороги (75ms и 150ms) и как они соотносятся с предыдущим опытом тестирования

---

## Пробелы в плане

### 1. RhythmAnalyzer.js — недостаточно деталей логики

**Проблема:** План говорит "recordHit() возвращает { zone: 'perfect' | 'good' | 'miss', ... }", но не описывает алгоритм определения зоны.

**Что нужно добавить:**
- Конкретную логику: `if (Math.abs(deviation) <= 75) → 'perfect'`, `else if (Math.abs(deviation) <= 150) → 'good'`, `else → 'miss'`
- Уточнение граничных случаев: использовать `<=` для включения границ (75ms и 150ms попадают в соответствующие зоны)
- Обновление статистики: заменить `accurateHits` на `perfectHits` и `goodHits`, обновить конструктор и `reset()`
- Детали `getAccuracy()`: что именно возвращать? Текущий формат `{ totalStrikes, accurateHits, misses, accuracyPercent }` нужно заменить на `{ totalStrikes, perfectHits, goodHits, misses, ... }` или добавить оба формата?

### 2. Animator.js — не указаны все изменения

**Проблема:** План говорит добавить цвет для "good", но не описывает все необходимые изменения.

**Что нужно добавить:**
- Добавить `good: '#FFC107'` в `this.colors`
- Обновить `onHit()`: заменить `result.isHit` на `result.zone` и добавить `case 'good'`
- Уточнить скорость волны для "good": использовать `HIT_WAVE_SPEED` или отдельную константу?
- Обновить логирование: вместо "ПОПАДАНИЕ/ПРОМАХ" → "PERFECT/GOOD/MISS"

### 3. Stats Screen — нет деталей по HTML и структуре данных

**Проблема:** План говорит "Три числа: Perfect (15), Good (8), Miss (3)", но не описывает, как изменить HTML и откуда брать данные.

**Что нужно добавить:**
- Изменения в `index.html`: 
  - Заменить один элемент `stats-accuracy` на три элемента (`stats-perfect`, `stats-good`, `stats-miss`)?
  - Или добавить три новых элемента рядом с существующими?
  - Какую структуру использовать (три колонки, вертикальный список)?
- Изменения в `app.js`:
  - Как обновить `showStatsScreen()` для отображения трёх чисел?
  - Откуда брать данные — из `rhythmAnalyzer.getAccuracy()`? Какой формат данных ожидается?
- Уточнение: убрать процент полностью или оставить как summary (как указано в плане "или оставить как summary")?

### 4. app.js — неполное описание изменений

**Проблема:** План упоминает только логирование, но не все места использования `result.isHit`.

**Что нужно добавить:**
- Проверить все места, где используется `result.isHit` (если они есть)
- Обновить логирование в обработчике ударов (строка ~318 в текущем коде)
- Уточнить, нужно ли обновлять промежуточное логирование статистики (строка ~334)

### 5. Обратная совместимость — не решено

**Проблема:** План говорит "можно оставить isHit для совместимости" или "убрать сразу", но не даёт рекомендации.

**Что нужно добавить:**
- Конкретное решение: оставить `isHit = zone !== 'miss'` или убрать полностью?
- Если оставить — указать, где это нужно добавить в `recordHit()`
- Если убрать — указать, что нужно проверить все места использования

### 6. Acceptance Criteria — несоответствие

**Проблема:** В `user_stories.json` указано "Пороги подобраны для детей разных возрастов", но в плане пороги фиксированные для 6-12 лет.

**Что нужно добавить:**
- Уточнение: оставляем фиксированные пороги или делаем адаптивные?
- Если адаптивные — как определять возраст/уровень? Где хранить настройки?
- Если фиксированные — отметить, что это решение для текущей версии, можно расширить позже

### 7. Тестирование — недостаточно конкретики

**Проблема:** Есть чеклист, но нет конкретных тестовых сценариев.

**Что нужно добавить:**
- Конкретные значения для тестов: удар на ±0ms, ±75ms, ±76ms, ±150ms, ±151ms
- Проверка граничных случаев: что происходит при ударе точно на границе (±75ms, ±150ms)?
- Проверка статистики: убедиться, что счётчики увеличиваются правильно
- Проверка визуализации: все три цвета отображаются корректно

---

## Конфликты с существующей архитектурой

Конфликтов не обнаружено. План корректно расширяет существующую функциональность без нарушения архитектуры.

---

## Рекомендации для доработки

1. **Добавить детальный алгоритм определения зоны** в раздел "RhythmAnalyzer.js":
   ```javascript
   // Определение зоны по отклонению
   let zone
   if (Math.abs(deviation) <= 75) {
     zone = 'perfect'
   } else if (Math.abs(deviation) <= 150) {
     zone = 'good'
   } else {
     zone = 'miss'
   }
   ```

2. **Детализировать изменения в статистике** в RhythmAnalyzer.js:
   - Заменить `accurateHits` на `perfectHits` и `goodHits`
   - Обновить конструктор: `this.perfectHits = 0`, `this.goodHits = 0`
   - Обновить `reset()`: сбросить все три счётчика
   - Описать формат возврата `getAccuracy()`: `{ totalStrikes, perfectHits, goodHits, misses, ... }`

3. **Добавить детали по Animator.js**:
   - Добавить `good: '#FFC107'` в `this.colors`
   - Описать switch/case в `onHit()` для трёх зон
   - Уточнить скорость волны для "good" (использовать `HIT_WAVE_SPEED` или отдельную константу)

4. **Детализировать изменения Stats Screen**:
   - Описать структуру HTML: три элемента вместо одного или три новых элемента
   - Указать, как обновить `showStatsScreen()` в `app.js`
   - Уточнить формат данных из `getAccuracy()` для отображения

5. **Решить вопрос обратной совместимости**:
   - Рекомендация: убрать `isHit` сразу, т.к. используется только внутри проекта (как указано в плане)
   - Или явно указать: оставить `isHit = zone !== 'miss'` для совместимости

6. **Уточнить вопрос с порогами для разных возрастов**:
   - Отметить, что фиксированные пороги выбраны для текущей версии
   - Или описать, как сделать адаптивные пороги (если планируется)

7. **Добавить конкретные тестовые сценарии**:
   - Удар на ±0ms → ожидается 'perfect'
   - Удар на ±75ms → ожидается 'perfect' (граница включена)
   - Удар на ±76ms → ожидается 'good'
   - Удар на ±150ms → ожидается 'good' (граница включена)
   - Удар на ±151ms → ожидается 'miss'

8. **Добавить шаг проверки** после каждого изменения:
   - После изменения RhythmAnalyzer → проверить логирование зон
   - После изменения Animator → проверить визуализацию трёх цветов
   - После изменения Stats Screen → проверить отображение трёх чисел

---

## Итоговая оценка

План правильный по направлению, но требует доработки в деталях реализации. Основные проблемы:
- Недостаточно конкретики в алгоритмах (определение зоны, обновление статистики)
- Не описаны изменения в HTML структуре Stats Screen
- Не решён вопрос обратной совместимости
- Несоответствие с Acceptance Criteria по адаптивным порогам

После добавления указанных деталей план будет готов к реализации.
