## Ревью плана: US-012 Система локаций (архитектура)

### Вердикт: Требует доработки

### Соответствие архитектуре (project_state.md)

- План соответствует целевой V2-архитектуре из `project_state.md`: `Animator → LocationRegistry → ForestLocation`, и корректно оставляет `Animator` владельцем PixiJS lifecycle.
- План не конфликтует с текущим стеком из `project_state.md` (PixiJS + vanilla JS/CSS).
- План учитывает требование из `project_state.md` про fallback при недоступном WebGL (в разделе «Верификация» явно указано проверить, что поведение не изменилось).

### Пробелы в плане

- В «Слайс 1» описан `LocationRegistry API`, но не описано, **где и когда регистрируется** `default`-локация. → Добавить явный шаг bootstrap: регистрация `default` при загрузке модуля (или отдельный `registerLocations()` в `app.js` до рендера Setup Screen).
- В «Слайс 1» есть изменение конструктора `Animator(..., locationId)`, но не зафиксировано сохранение текущего публичного API `onHit(result)` для `app.js` (сейчас `app.js` передаёт весь `result`). → Явно добавить в план: `Animator.onHit(result)` остаётся совместимым, а внутри маппится в `location.onHit(result.zone)`.
- В «Слайс 2» сказано «Выбор сохраняется в localStorage», но не описана миграция существующих сохранённых настроек (`SETTINGS_KEY` сейчас хранит только `bpm/duration/devMode`). → Добавить шаг backward-compatible чтения: при отсутствии `locationId` использовать `LocationRegistry.getDefaultId()`.
- В «Слайс 1» не описана обработка случая, когда в localStorage лежит невалидный `locationId` или `create(id)` выбрасывает ошибку. → Добавить fallback-логику: warning + автоматический переход на `default` без падения сессии.
- В «Верификация» есть «логи LocationRegistry видны», но нет проверки acceptance-критерия «переключение локации без перезагрузки страницы». → Добавить явный тест-сценарий: сменить локацию в Setup, старт/стоп, снова сменить и запустить без reload.

### Конфликты с существующей архитектурой

Конфликтов не обнаружено.

### Рекомендации для доработки

1. В «Слайс 1» добавить отдельный подпункт «Инициализация реестра»: где выполняется регистрация `DefaultLocation` и в какой момент жизненного цикла приложения.
2. В «Слайс 1» зафиксировать контракт совместимости `Animator`: сохранить `onHit(result)` и не ломать текущий вызов из `src/web/js/app.js`.
3. В «Слайс 1» добавить защиту от невалидного `locationId`: try/catch вокруг `LocationRegistry.create()`, fallback на `getDefaultId()`.
4. В «Слайс 2» описать изменение схемы настроек в localStorage и дефолтное значение `locationId` для старых записей.
5. В «Верификация» добавить отдельный сценарий проверки AC «переключение локации без перезагрузки» и сценарий с невалидным `locationId` в localStorage.
