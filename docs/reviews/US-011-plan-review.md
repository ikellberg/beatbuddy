## Ревью плана: US-011 Интеграция PixiJS для анимаций

### Вердикт: Требует доработки

### Соответствие архитектуре (project_state.md)

✅ **Правильно учитывает архитектуру:**
- План корректно учитывает замену Canvas 2D на PixiJS, что соответствует архитектуре V2 из project_state.md: "Стек V2: PixiJS для анимаций, vanilla JS + CSS для UI"
- Сохранение API `start()/stop()/onHit(result)` для `app.js` — правильно, соответствует текущей интеграции
- CDN-подключение PixiJS соответствует ограничениям проекта (нет внешних зависимостей в виде npm-пакетов)

⚠️ **Не учитывает будущую архитектуру:**
- В project_state.md указана будущая архитектура: `Animator → LocationRegistry → ForestLocation (PixiJS)`
- План не упоминает, как текущая реализация будет совместима с будущей системой локаций (US-012)
- Рекомендация: добавить примечание, что текущая реализация должна быть подготовлена к будущему рефакторингу с LocationRegistry

### Пробелы в плане

1. **Синхронизация с метрономом** → В текущем `Animator.js` фоновая волна синхронизируется с метрономом через расчет на основе `elapsedSeconds` и `BPM` (строки 152-169). План не упоминает, как сохранить эту синхронизацию в PixiJS. Нужно добавить в Слайс 1: "Сохранить синхронизацию фоновой пульсации с BPM через ticker и расчет фазы волны на основе elapsed time"

2. **Тестирование на Windows 7 + Chrome** → В project_state.md указано: "Боевое окружение — Windows 7 + Chrome (больница)" и "WebGL на Windows 7 может тормозить — предусмотреть fallback/тестирование". План не упоминает обязательное тестирование на этой платформе. Нужно добавить в Верификацию: "Тестирование на Windows 7 + Chrome (или эмуляция через отключение WebGL)"

3. **Утечки памяти при длительной работе** → В acceptance criteria указано: "Нет утечек памяти при длительной работе (10+ минут)". План упоминает cleanup в Слайсе 4, но не конкретизирует тестирование длительной работы. Нужно добавить в Слайс 4: "Smoke-тест длительной работы (10+ минут) с проверкой использования памяти в DevTools"

4. **Производительность 60fps** → В acceptance criteria указано: "Плавность 60fps на целевом оборудовании" и "Стабильные 60fps на Windows 7 + Chrome". План не упоминает проверку FPS. Нужно добавить в Слайс 4: "Проверка FPS через `app.ticker.FPS` или DevTools Performance, должно быть стабильно 60fps"

5. **Fallback-сообщение пользователю** → В acceptance criteria: "Fallback: если WebGL недоступен — показать сообщение (не падать молча)". План упоминает "отобразить пользователю сообщение через app.js (в статусе сессии)", но не указывает:
   - Где именно показывать (в `metronome-status` или отдельный элемент?)
   - Какой текст сообщения
   - Должен ли аниматор продолжать работать в fallback-режиме (Canvas 2D) или просто показывать сообщение?
   Нужно конкретизировать в Слайсе 3

6. **Сохранение визуального стиля** → Текущий Animator рисует волны от центра canvas. План не упоминает, нужно ли сохранить этот визуальный стиль или можно изменить. Рекомендация: добавить в Слайс 1 примечание о сохранении текущего визуального стиля (волны от центра)

7. **Обработка ошибок PixiJS** → План не упоминает обработку ошибок при инициализации PixiJS (например, если canvas не найден или невалидный размер). Нужно добавить в Слайс 1: "Обработка ошибок при создании PIXI.Application с fallback-поведением"

### Конфликты с существующей архитектурой

Конфликтов не обнаружено. План корректно учитывает текущую архитектуру и не нарушает существующие модули.

### Рекомендации для доработки

1. **Слайс 1:** Добавить пункт про синхронизацию фоновой пульсации с BPM через расчет фазы волны на основе elapsed time (как в текущем Animator.js, строки 152-169)

2. **Слайс 1:** Добавить обработку ошибок при создании `PIXI.Application` (canvas не найден, невалидный размер) с fallback-поведением

3. **Слайс 1:** Добавить примечание о сохранении текущего визуального стиля (волны от центра canvas)

4. **Слайс 3:** Конкретизировать fallback-поведение:
   - Где показывать сообщение (элемент в DOM)
   - Текст сообщения
   - Должен ли аниматор работать в Canvas 2D fallback или только показывать сообщение?

5. **Слайс 4:** Добавить проверку FPS через `app.ticker.FPS` или DevTools Performance

6. **Слайс 4:** Добавить smoke-тест длительной работы (10+ минут) с проверкой использования памяти в DevTools

7. **Верификация:** Добавить обязательное тестирование на Windows 7 + Chrome (или эмуляцию через отключение WebGL в DevTools)

8. **Общее:** Добавить примечание о совместимости с будущей архитектурой LocationRegistry (US-012), чтобы текущая реализация не усложняла будущий рефакторинг
