---
name: code-review
description: Код-ревью реализации по User Story. Сверяет код с требованиями стори и архитектурой проекта. Используй когда пользователь просит сделать код-ревью, проверить реализацию, или упоминает "code review", "ревью кода", "проверить код".
---

# Code Review

Этот скилл проверяет код, написанный LLM, на соответствие требованиям User Story и архитектуре проекта. Результат — конкретный фидбек для доработки.

## Вход

Пользователь указывает ID стори, например: "Сделай код-ревью US-001"

## Шаг 1: Собери контекст

Прочитай параллельно:

1. **project_state.md** — текущая архитектура, паттерны, что уже реализовано
2. **docs/user_stories.json** — найди стори по ID, получи:
   - `acceptanceCriteria` — что должно быть реализовано
   - `technicalNotes` — технические требования
   - `relatedFiles` — какие файлы должны быть затронуты

## Шаг 2: Посмотри изменения

Выполни команды:

```bash
git status
git diff
```

Это покажет unstaged изменения — то, что написала LLM.

Если изменений нет или непонятно что смотреть — спроси у пользователя.

## Шаг 3: Прочитай изменённые файлы

Прочитай каждый изменённый файл целиком, чтобы понять контекст.

## Шаг 4: Проанализируй код

### Философия ревью

**Дай объективную оценку.** Каждое замечание должно быть фактом, а не интерпретацией. "Не реализован AC X" — факт. "Код мог бы быть лучше" — не замечание. Разработчик отработает замечания: исправит или обоснует почему оставляет.

Лучше указать на потенциальную проблему, чем пропустить реальную.

### Чеклист проверки

**Соответствие требованиям:**
- [ ] Каждый пункт AC реализован
- [ ] Технические требования из `technicalNotes` соблюдены
- [ ] Изменены правильные файлы (из `relatedFiles`)

**Соответствие архитектуре (project_state.md):**
- [ ] Код следует паттернам проекта
- [ ] Использует существующие модули где нужно
- [ ] Не дублирует функционал
- [ ] Структура файлов соответствует проекту

**Качество кода:**
- [ ] Читаемые имена переменных/функций
- [ ] Нет магических чисел без пояснения
- [ ] Обработка ошибок где нужно
- [ ] Код соответствует стилю проекта (см. CLAUDE.md если есть)

**Надёжность:**
- [ ] Нет очевидных багов
- [ ] Edge cases учтены (null, пустые значения, граничные условия)
- [ ] Типы данных корректны

**Безопасность:**
- [ ] Нет захардкоженных секретов
- [ ] Нет уязвимостей (XSS, инъекции)

### Категории замечаний

При выводе замечаний указывай категорию:

**[БЛОКЕР]** — не выполнен AC, баг, нарушение архитектуры, безопасность. Требует исправления.

**[ЗАМЕЧАНИЕ]** — качество кода, читаемость, edge cases, стиль. Разработчик должен рассмотреть и либо исправить, либо обосновать почему оставляет как есть.

## Шаг 5: Сохрани ревью в файл

**ОБЯЗАТЕЛЬНО** сохрани результат ревью в файл:
- Путь: `docs/reviews/US-XXX-code-review.md`

ВАЖНО: Результат будет передан другой LLM для доработки. Формат должен быть максимально удобен для машинной обработки.

### Формат файла

```markdown
## Код-ревью: [ID стори] — [название стори]

### Вердикт: [Готов к коммиту / Требует доработки]

### Невыполненные Acceptance Criteria

(Только если есть невыполненные. Если все AC выполнены — пропусти секцию)

- **AC: "[текст критерия]"** — не реализовано. В `relatedFiles` указан `[файл]`, но [что не так].

### Замечания к коду

(Пронумерованный список. Каждое замечание — отдельный пункт для отработки)

1. **[БЛОКЕР/ЗАМЕЧАНИЕ]** **[Файл], строка [N]**: [Что не так]
   - Сейчас: `[проблемный код или описание]`
   - Нужно: `[как должно быть]`
   - Причина: [почему это важно — ссылка на AC, project_state.md или best practice]

2. **[БЛОКЕР/ЗАМЕЧАНИЕ]** **[Файл], строка [N]**: [...]
```

## Шаг 6: Сообщи пользователю

После сохранения файла сообщи:
- Путь к файлу ревью
- Краткий вердикт

## Правила ревью

1. **Формат для LLM** — каждое замечание должно быть понятно без дополнительного контекста
2. **Файл + строка** — всегда указывай точное место
3. **Сейчас/Нужно** — покажи что есть и что должно быть
4. **Причина** — объясни почему (ссылка на AC, project_state.md, или объективная причина)
5. **Категория** — [БЛОКЕР] или [ЗАМЕЧАНИЕ] в начале каждого пункта

## Вердикты

- **Готов к коммиту** — все AC выполнены, нет блокеров
- **Требует доработки** — есть невыполненные AC или блокеры

## Пример

Пользователь: "Сделай код-ревью US-002"

Ты:
1. Читаешь `project_state.md` и `docs/user_stories.json`
2. Находишь US-002: "Точный метроном с низкой задержкой"
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Сверяешь код с AC из стори
6. Выдаёшь ревью в формате выше
